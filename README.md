# _precisionFDA_ COVID-19 Risk Factor Modeling

<h3 align="right"><img src="https://raw.githubusercontent.com/BlueGranite/precisionFDA_VAH_COVID-19/master/img/bg_logo.png" width="200px" alt="BlueGranite, Inc."></h3>

<h3 align="right">Colby T. Ford, Thomas J. Weinandy, David Barnhart, Megan Quinn</h3>

The Veterans Health Administration (VHA) Innovation Ecosystem and Food and Drug Administration (FDA) call on the scientific and analytics community to develop and evaluate computational models to predict COVID-19 related health outcomes in Veterans. 

##  At A Glance

The novel coronavirus disease 2019 (COVID-19) is a respiratory disease caused by a new type of coronavirus, known as “severe acute respiratory syndrome coronavirus 2,” or SARS-CoV-2. On March 11, 2020, the World Health Organization (WHO) declared the outbreak a global pandemic.

The Centers for Disease Control and Prevention (CDC) have identified several groups at elevated risk for severe illness, including people 65 years and older, individuals living in nursing homes or long term care facilities, and those with serious underlying medical conditions, such as severe obesity, diabetes, chronic lung disease or moderate to severe asthma, chronic kidney or liver disease, and immunocompromised individuals. Identifying risk and protective factors for severe COVID-19 illness is crucial to better protect, triage, and treat at-risk individuals.

In this regard, the U.S. Department of Veterans Affairs (VA) has implemented several measures in response to the pandemic to protect and care for Veterans, including developing a COVID-19 response plan, administering over 165,000 COVID-19 tests, implementing outreach, screening, and protective procedures to prevent transmission, and supporting non-VA health care facilities. These steps are crucial to protect the Veteran population that has a higher prevalence of several of the known risk factors for severe COVID-19 illness, such as advanced age, heart disease, and diabetes.

To better understand the risk and protective factors in the Veteran population, the VHA Innovation Ecosystem and precisionFDA are calling upon the public to develop machine learning and artificial intelligence models to predict COVID-19 related health outcomes, including COVID-19 status, length of hospitalization, and mortality, using synthetic Veteran health records. Through this challenge, additional risk and protective factors will be investigated, including therapeutics prescribed for preexisting comorbidities, and treatment interactions. 

<p align="right">For more information about the challenge, visit the <a href="https://precision.fda.gov/challenges/11" target="_blank">precisionFDA challenge site</a>.</p>

## Our Approach

The Data + AI team at BlueGranite has leveraged Azure cloud-based tools and large-scale machine learning for formulating predictions for the VHA Innovation Ecosystem and precisionFDA COVID-19 Risk Factor Modeling Challenge. We primarily utilized Azure Databricks with the Apache Spark engine and MLlib library for performing the data preparation and machine learning. This allows for highly scalable data transformations and shaping, modeling, and data scoring.

For all five of the constituent use cases of this challenge, we pre-shaped the synthetic medical record data provided by the challenge and then used this common dataset for training the models. Specifically, we rolled up each table to the patient level by pivoting the data. (Only data prior to 2020 was used.)

<img src="https://raw.githubusercontent.com/BlueGranite/precisionFDA_VAH_COVID-19/master/img/pivot.png" alt="">

The Observations table was pivoted and minimum, maximum, average, and standard deviation features were derived for each of the observations. Smoking status was aggregated to the patient-level by taking the latest smoking status to date.
A dataset of city demographics was retrieved from the Synthea Github repository. This data was aggregated to the city-level and joined to the main challenge data by city.

All of these pivoted datasets were joined to the patient data to generate a summarized full medical view of each individual. This common patient information dataset was then joined to the individual dependent variable information for each of the constituent use cases, thus generating five training datasets.
|                       Table                     |                                  Transformation                                |                                  Resulting   Shape                                 |
|:-----------------------------------------------:|:------------------------------------------------------------------------------:|:----------------------------------------------------------------------------------:|
|     Allergies                                   |     Pivoted, Presence/Absence by Allergy                                       |     Patient ID, Dataset     15 Allergy Columns                                     |
|     Care Plans                                  |     Pivoted, Presence/Absence by Care Plan                                     |     Patient ID, Dataset     35 Care Plan Columns                                   |
|     Conditions                                  |     Pivoted, Presence/Absence by Condition                                     |     Patient ID, Dataset     158 Condition Columns                                  |
|     Devices                                     |     Pivoted, Presence/Absence by Device                                        |     Patient ID, Dataset     6 Device Columns                                       |
|     Encounters                                  |     -Not Used-                                                                 |     N/A                                                                            |
|     Imaging Studies                             |     Pivoted, Presence/Absence by Imaging   Study                               |     Patient ID, Dataset     9 Imaging Study Columns                                |
|     Immunizations                               |     Pivoted, Presence/Absence by   Immunization                                |     Patient ID, Dataset     17 Immunization Columns                                |
|     Medications                                 |     Pivoted, Sum by Medication                                                 |     Patient ID, Dataset     166 Medication Columns                                 |
|     Observations                                |     Pivoted, Count by Observation     (except Smoker Status: Latest Status)    |     Patient ID, Dataset     203 Observation Columns,     1 Smoker Status Column    |
|     Organizations                               |     -Note Used-                                                                |     N/A                                                                            |
|     Patients                                    |     None. Removal of unnecessary columns.                                      |     Patient ID, Dataset     12 Patient Information Columns                         |
|     Payer Transitions                           |     -Not Used-                                                                 |     N/A                                                                            |
|     Payers                                      |     -Not Used-                                                                 |     N/A                                                                            |
|     Procedures                                  |     Pivoted, Count by Procedure                                                |     Patient ID, Dataset     164 Procedure Columns                                  |
|     Providers                                   |     -Not Used-                                                                 |     N/A                                                                            |
|     Supplies                                    |     -Not Used-                                                                 |     N/A                                                                            |
|     External: City Demographics     [Source]    |     Aggregated to City Level                                                   |     42 City-Level Columns                                                          |
|                                                 |                                                                          Total |     828 Columns                                                                    |

### Modeling

All models below were 5-fold cross-validated and a hyperparameter sweep was performed for each algorithm, selecting the combination with the best AUPR (area under the precision-recall curve). Then, between best models of different algorithms, the model with the best overall accuracy, AUC (area under the receiver operating characteristic curve), and AUPR was chosen. Metrics shown are from scoring against the training data.

| Use Case                        	| Models and Parameters Tested<br>     (* Denotes Best Model/Parameter)                                                                                                                                                                                                                                                                                                                                                                                                                                               	| Best Model’s Metrics                               	| Important Features<br>     (Obs: Observation)                                                                                                                                                                                                                                                                                                                                                     	|
|---------------------------------	|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	|----------------------------------------------------	|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	|
| COVID-19 Status                 	| Logistic Regression:<br>     •	λ1 Regularization: 0.01, 0.1, 0.5<br>     •	λ2 Regularization: 0.01, 0.1, 0.25<br>     •	Max Iterations: 1, 5, 10<br>     Decision Tree:<br>     •	Max Depth: 2, 5, 10<br>     •	Max Bins: 10, 20<br>     Random Forest*:<br>     •	Max Depth: 2, 5, 10*<br>     •	Max Bins: 5, 10*, 20<br>     •	Number of Trees: 5, 20*, 50                                                                                                                                                                	| Accuracy: 0.90489<br>AUC: 0.92507<br>AUPR: 0.97769 	| Top 10 by Gini index:<br>     •	QALY_Max: 0.18216<br>     •	DALY_Max: 0.10518<br>     •	QALY_Min: 0.08577<br>     •	QALY_Avg: 0.06544<br>     •	DALY_Avg: 0.06055<br>     •	QOLS_Avg: 0.03970<br>     •	DALY_Min: 0.03609<br>     •	QOLS_Min: 0.02378<br>     •	(Obs) 2708-6_Max: 0.01997<br>     •	condition_162573006: 0.01480                                                                            	|
| Days Hospitalized               	| Linear Regression:<br>     •	λ1 Regularization: 0.01, 0.1, 0.5<br>     •	λ2 Regularization: 0, 0.1, 0.25<br>     •	Max Iterations: 1, 5, 10<br>     Poisson Regression:<br>     •	λ1 Regularization: 0.01, 0.1, 0.5<br>     •	Max Iterations: 1, 5, 10<br>     •	Link: Log<br>     Decision Tree Regression:<br>     •	Max Depth: 2, 5, 10<br>     •	Max Bins: 10, 20, 50, 100<br>     Random Forest Regression*:<br>     •	Max Depth: 2, 5, 10*<br>     •	Max Bins: 10, 25, 50, 100*<br>     •	Number of Trees: 5, 20, 50*    	| R2: 0.15742<br>RMSE: 4.54910<br>MAE: 3.68118       	| Top 10 by Gini index:<br>     •	age_years: 0.19432<br>     •	Healthcare_Coverage: 0.05176<br>     •	Revenue: 0.03974<br>     •	QALY_Max: 0.03599<br>     •	QALY_Avg: 0.02010<br>     •	(Obs) 2069-3_StdDev: 0.01893<br>     •	QALY_Min: 0.01724<br>     •	pct_covered: 0.01126<br>     •	(Obs) 49765-1_StdDev: 0.01119<br>     •	(Obs) 20565-8_StdDev: 0.00832                                              	|
| Days in ICU                     	| Linear Regression:<br>     •	λ1 Regularization: 0.01, 0.1, 0.5<br>     •	λ2 Regularization: 0.01, 0.1, 0.25<br>     •	Max Iterations: 1, 5, 10<br>     Poisson Regression:<br>     •	λ1 Regularization: 0.01, 0.1, 0.5<br>     •	Max Iterations: 1, 5, 10<br>     •	Link: Log<br>     Decision Tree Regression:<br>     •	Max Depth: 2, 5, 10<br>     •	Max Bins: 10, 20, 50, 100<br>     Random Forest Regression*:<br>     •	Max Depth: 2, 5*, 10<br>     •	Max Bins: 10, 25*, 50, 100<br>     •	Number of Trees: 5, 20, 50* 	| R2: 0.04036<br>RMSE: 2.69268<br>MAE: 2.23153       	| Top 10 by Gini index:<br>     •	age_years: 0.13917<br>     •	QALY_Avg: 0.05914<br>     •	QALY_Max: 0.05405<br>     •	QALY_Min: 0.03569<br>     •	(Obs) 29463-7_Avg: 0.02228<br>     •	DALY_Min	0.01398<br>     •	(Obs) 8302-2_Max: 0.01357<br>     •	(Obs) 29463-7_Max: 0.01331<br>     •	(Obs) 8462-4_Min: 0.01265<br>     •	DALY_Max: 0.01218                                                              	|
| Controlled Ventilation   Status 	| Logistic Regression:<br>     •	λ1 Regularization: 0.01, 0.1, 0.5<br>     •	λ2 Regularization: 0.01, 0.1, 0.25<br>     •	Max Iterations: 1, 5, 10<br>     Decision Tree*:<br>     •	Max Depth: 2, 5*, 10, 35<br>     •	Max Bins: 10, 20*, 50<br>     Random Forest:<br>     •	Max Depth: 2, 5, 10<br>     •	Max Bins: 5, 10, 20<br>     •	Number of Trees: 5, 20, 50                                                                                                                                                         	| Accuracy: 0.67871<br>RMSE: 2.69268<br>MAE: 2.23153 	| Top 10 by Gini index:<br>     •	age_years: 0.48623<br>     •	procedure_703423002: 0.13805<br>     •	procedure_265764009: 0.06594<br>     •	(Obs) 18262-6_Max: 0.04079<br>     •	(Obs) 9279-1_Max: 0.03450<br>     •	condition_431856006: 0.03101<br>     •	careplan_443402002: 0.02297<br>     •	City_Age_25_29: 0.022480112<br>     •	City_Income_50_75K: 0.02180<br>     •	CityclassVec_Cheshire: 0.02157 	|
| Alive or Deceased Status        	| Logistic Regression:<br>     •	λ1 Regularization: 0.01, 0.1, 0.5<br>     •	λ2 Regularization: 0.01, 0.1, 0.25<br>     •	Max Iterations: 1, 5, 10<br>     Decision Tree:<br>     •	Max Depth: 2, 5, 10<br>     •	Max Bins: 10, 20<br>     Random Forest*:<br>     •	Max Depth: 2, 5, 10*<br>     •	Max Bins: 5, 10, 20*<br>     •	Number of Trees: 5, 20, 50*                                                                                                                                                                	| Accuracy: 0.84505<br>AUC: 0.96507<br>AUPR: 0.99992 	| Top 10 by Gini index:<br>     •	age_years: 0.03851<br>     •	QALY_Max: 0.03060<br>     •	QALY_Min: 0.02454<br>     •	medication_583214: 0.02101<br>     •	procedure_703423002: 0.01593<br>     •	QALY_Avg: 0.01542<br>     •	Healthcare_Coverage: 0.01492<br>     •	medication_1736854: 0.01422<br>     •	Revenue: 0.01417<br>     •	(Obs) 2069-3_Avg: 0.00778                                              	|

